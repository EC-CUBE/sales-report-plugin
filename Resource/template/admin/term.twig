{#
 This file is part of the Sales Report plugin

Copyright (C) 2016 LOCKON CO.,LTD. All Rights Reserved.

 For the full copyright and license information, please view the LICENSE
 file that was distributed with this source code.
#}

{% extends 'SalesReport/Resource/template/admin/index.twig' %}
{% block sub_title %}用語レポート{% endblock %}

{% set report_title = '期間別集計' %}
{% set action = url('admin_plugin_sales_report_term') %}
{% set menus = ['customer', 'admin_plugin_sales_report', 'admin_plugin_sales_report_term'] %}

{% block stylesheet %}
    <style>
        #sales_report_unit > div{ float: left; padding-right: 15px}
    </style>
{% endblock stylesheet %}

{% block chart %}
    <script>
        var graphData = {{ graphData|raw }};

        window.onload = function() {
            //create line chart
            if(graphData != null) {
                var dataSet = graphData.datasets;
                graphData.datasets = [dataSet];
                {% if options.unit is defined and (options.unit == 'byWeekDay' or options.unit == 'byHour') %}
                    var config = {
                        type: 'bar',
                        data: graphData,
                        options: {
                            responsive: true,
                            tooltips: {
                                callbacks: {
                                    label : function tooltipsRender(tooltipItem, graphData) {
                                        var index = tooltipItem.index;
                                        var tooltipData = graphData.datasets[0].data[index];
                                        var tooltipLabel = graphData.labels[index];
                                        return '購入合計 : ¥' + moneyFormat(tooltipData);
                                    }
                                }
                            },
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        callback: function(value){
                                            return Math.round(value).toString().replace(/(\d)(?=(\d{3})+$)/g, '$1,');
                                        }
                                    }
                                }]
                            }
                        }
                    };
                {% else %}
                    var config = {
                        type: 'line',
                        data: graphData,
                        options: {
                            responsive: true,
                            tooltips: {
                                callbacks: {
                                    label : function tooltipsRender(tooltipItem, graphData) {
                                        var index = tooltipItem.index;
                                        var tooltipData = graphData.datasets[0].data[index];
                                        var tooltipLabel = graphData.labels[index];
                                        return '購入合計 : ¥' + moneyFormat(tooltipData);
                                    }
                                }
                            },
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        callback: function(value){
                                            return Math.round(value).toString().replace(/(\d)(?=(\d{3})+$)/g, '$1,');
                                        }
                                    }
                                }]
                            }
                        }
                    };
                {% endif %}
                var ctx = document.getElementById("chart").getContext("2d");
                new Chart(ctx, config);
            }
            //export csv
            $('#export-csv').click(function () {
                var form = document.createElement("form");
                form.setAttribute("method", 'POST');
                form.setAttribute("action", "{{ url('admin_plugin_sales_report_export', { type : 'term' }) }}");
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            });
        };
    </script>
{% endblock %}

{% block option %}
    <div class="row form-group">
        <div class="col-12 col-sm-2"><span>集計単位</span></div>
        <div class="col-auto col-lg-auto form-inline">
            {{ form_widget(form.unit) }}
            {{ form_errors(form.unit) }}
        </div>
    </div>
{% endblock %}

{% block table %}
    {% if app.request.method == 'POST' %}
        <div class="card-body">
            <div class="row">
                {% if rawData is not null %}
                    <div class="col-12 text-right mb-2">
                        <div class="d-inline-block">
                            <div class="btn-group d-inline-block" role="group">
                                <button type="button" class="btn btn-ec-regular" id="export-csv"><i class="fa fa-cloud-download mr-1 text-secondary"></i> CSVダウンロード
                                </button>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped" id="term-table">
                        <thead>
                        <tr>
                            <th class="border-top-0 pt-2 pb-2 text-center">期間</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">購入件数</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">男性</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">女性</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">不明</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">男性 (会員)</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">男性 (非会員)</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">女性 (会員)</th>
                            <th class="border-top-0 pt-2 pb-2 text-center">女性 (非会員)</th>
                            <th class="border-top-0 pt-2 pb-2 text-right">購入合計(円)</th>
                            <th class="border-top-0 pt-2 pb-2 text-right">購入平均(円)</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for date, row in rawData %}
                            <tr>
                                <td class="align-middle text-center pl-3">{{ date }}</td>
                                <td class="align-middle text-center pl-3">{{ row.time|number_format }}</td>

                                <td class="align-middle text-center pl-3">{{ row.male|number_format }}</td>
                                <td class="align-middle text-center pl-3">{{ row.female|number_format }}</td>
                                <td class="align-middle text-center pl-3">{{ row.other|number_format }}</td>
                                <td class="align-middle text-center pl-3">{{ row.member_male|number_format }}</td>
                                <td class="align-middle text-center pl-3">{{ row.nonmember_male|number_format }}</td>
                                <td class="align-middle text-center pl-3">{{ row.member_female|number_format }}</td>
                                <td class="align-middle text-center pl-3">{{ row.nonmember_female|number_format }}</td>

                                <td class="price-format text-right">
                                    {{ row.price|number_format }}
                                    <span class="hidden">{{ row.price }}</span>
                                </td>
                                <td class="price-format text-right">
                                    {% if row.time > 0 %}
                                        {{ (row.price / row.time)|round(2, 'floor')|number_format }}
                                    {% else %}
                                        0
                                    {% endif %}
                                    <span class="hidden">
                                                    {% if row.time > 0 %}
                                                        {{ (row.price / row.time)|round(2, 'floor') }}
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </span>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <h3 class="box-title">集計期間にデータがありませんでした。</h3>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}
